<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø­Ù„Ù„ Ø§Ù„ØªØ±ÙŠÙƒØ³ Ø§Ù„Ø°ÙƒÙŠ - Template Matching</title>
    <script async src="https://docs.opencv.org/4.5.0/opencv.js" onload="onOpenCvReady();"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; background: #1a1a2e; color: white; padding: 20px; }
        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; max-width: 400px; margin: 20px auto; }
        .card { background: #16213e; border: 2px solid #0f3460; border-radius: 10px; padding: 15px 5px; font-weight: bold; transition: 0.4s; color: #e94560; }
        .hidden { opacity: 0.1; filter: grayscale(100%); border-color: transparent; transform: scale(0.8); }
        #status { background: #0f3460; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-bottom: 3px solid #e94560; }
        #imageInput { margin: 10px 0; padding: 10px; color: white; }
    </style>
</head>
<body>

    <div id="status">Ø¬Ø§Ø±ÙŠ ØªØ´ØºÙŠÙ„ Ù…Ø­Ø±Ùƒ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¨ØµØ±ÙŠ... âš™ï¸</div>
    
    <input type="file" id="imageInput" accept="image/*" disabled>
    
    <div class="grid" id="board"></div>

    <script>
        let cvReady = false;
        const cardsS = ['AS', 'KS', 'QS', 'JS', '10S', '9S', '8S', '7S', '6S', '5S', '4S', '3S', '2S'];

        function onOpenCvReady() {
            cvReady = true;
            document.getElementById('status').innerText = "Ø§Ù„Ù…Ø­Ø±Ùƒ Ø¬Ø§Ù‡Ø²! Ø§Ø±ÙØ¹ Ù„Ù‚Ø·Ø© Ø§Ù„Ø´Ø§Ø´Ø© ğŸš€";
            document.getElementById('imageInput').disabled = false;
            initBoard();
        }

        function initBoard() {
            const board = document.getElementById('board');
            cardsS.forEach(card => {
                const div = document.createElement('div');
                div.className = 'card';
                div.id = `card-${card}`;
                div.innerText = card;
                board.appendChild(div);
            });
        }

        document.getElementById('imageInput').addEventListener('change', async (e) => {
            if(!cvReady) return;
            const file = e.target.files[0];
            const img = await createImageBitmap(file);
            processImage(img);
        });

        async function processImage(imgSource) {
            document.getElementById('status').innerText = "Ø¬Ø§Ø±ÙŠ Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„ØµÙˆØ± (Template Matching)... ğŸ”";
            
            let src = cv.imread(imgSource);
            let srcGray = new cv.Mat();
            cv.cvtColor(src, srcGray, cv.COLOR_RGBA2GRAY, 0); // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ù„Ù„Ø±Ù…Ø§Ø¯ÙŠ Ù„Ø²ÙŠØ§Ø¯Ø© Ø¯Ù‚Ø© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©

            for (let card of cardsS) {
                await matchTemplateForCard(card, srcGray);
            }

            document.getElementById('status').innerText = "ØªÙ… Ø§Ù„Ù…Ø³Ø­ Ø¨Ù†Ø¬Ø§Ø­! âœ…";
            src.delete(); srcGray.delete();
        }

        async function matchTemplateForCard(cardName, srcGray) {
            try {
                const response = await fetch(`card_templates/${cardName}.png`);
                if (!response.ok) return;

                const blob = await response.blob();
                const templImg = await createImageBitmap(blob);
                let templ = cv.imread(templImg);
                let templGray = new cv.Mat();
                cv.cvtColor(templ, templGray, cv.COLOR_RGBA2GRAY, 0);

                let dst = new cv.Mat();
                let mask = new cv.Mat();
                
                // Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Template Matching
                cv.matchTemplate(srcGray, templGray, dst, cv.TM_CCOEFF_NORMED, mask);
                let result = cv.minMaxLoc(dst, mask);

                // Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ·Ø§Ø¨Ù‚ (Threshold)
                // Ù‚Ù…Øª Ø¨Ø®ÙØ¶Ù‡Ø§ Ù„Ù€ 0.65 Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ±Ù‚Ø© Ø­ØªÙ‰ Ù…Ø¹ Ø§Ø®ØªÙ„Ø§Ù Ø§Ù„Ø¥Ø¶Ø§Ø¡Ø©
                if (result.maxVal > 0.65) {
                    document.getElementById(`card-${cardName}`).classList.add('hidden');
                }

                templ.delete(); templGray.delete(); dst.delete(); mask.delete();
            } catch (err) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ù…Ø·Ø§Ø¨Ù‚Ø©: " + cardName, err);
            }
        }
    </script>
</body>
</html>
