<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø­Ù„Ù„ Ø§Ù„ØªØ±ÙŠÙƒØ³ Ø§Ù„Ø°ÙƒÙŠ</title>
    <script async src="https://docs.opencv.org/4.5.0/opencv.js" onload="onOpenCvReady();"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; background: #2c3e50; color: white; margin: 0; padding: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(70px, 1fr)); gap: 10px; padding: 15px; max-width: 500px; margin: auto; }
        .card { background: #ecf0f1; color: #333; border-radius: 8px; padding: 15px 5px; font-weight: bold; border: 2px solid transparent; transition: 0.3s; font-size: 14px; }
        .hidden { opacity: 0.15; transform: scale(0.85); filter: grayscale(100%); border: 2px solid red; }
        #status { margin: 20px auto; padding: 15px; border-radius: 10px; background: #34495e; max-width: 400px; border-left: 5px solid #3498db; }
        input[type="file"] { background: #3498db; color: white; padding: 10px; border-radius: 5px; border: none; cursor: pointer; margin-bottom: 20px; }
        .category-title { margin-top: 20px; color: #f1c40f; border-bottom: 1px solid #f1c40f; display: inline-block; padding: 0 10px; }
    </style>
</head>
<body>

    <h2>ğŸƒ Ø¹Ø¯Ù‘Ø§Ø¯ ÙˆØ±Ù‚ Ø§Ù„ØªØ±ÙŠÙƒØ³ Ø§Ù„Ø°ÙƒÙŠ</h2>
    <div id="status">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ø­Ø±Ùƒ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ... â³</div>
    
    <p>Ø§Ø±ÙØ¹ Ù„Ù‚Ø·Ø© Ø´Ø§Ø´Ø© Ù„Ù„Ø¹Ø¨Ø©:</p>
    <input type="file" id="imageInput" accept="image/*" disabled>
    
    <div class="category-title">Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø³Ø¨ÙŠØª (Spades)</div>
    <div class="grid" id="board-S"></div>

    <canvas id="canvasOutput" style="display:none;"></canvas>

    <script>
        let cvReady = false;
        // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ (Ø³Ù†Ø±ÙƒØ² Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¨ÙŠØª Ø­Ø§Ù„ÙŠØ§Ù‹ ÙˆÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ù‚ÙŠØ© Ø¨Ù†ÙØ³ Ø§Ù„Ù†Ù…Ø·)
        const cardsS = ['AS', 'KS', 'QS', 'JS', '10S', '9S', '8S', '7S', '6S', '5S', '4S', '3S', '2S'];

        function onOpenCvReady() {
            cvReady = true;
            document.getElementById('status').innerText = "Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø²! Ø§Ø±ÙØ¹ Ù„Ù‚Ø·Ø© Ø§Ù„Ø´Ø§Ø´Ø© ğŸš€";
            document.getElementById('imageInput').disabled = false;
            initBoard('board-S', cardsS);
        }

        function initBoard(id, list) {
            const board = document.getElementById(id);
            list.forEach(card => {
                const div = document.createElement('div');
                div.className = 'card';
                div.id = `card-${card}`;
                div.innerText = card;
                board.appendChild(div);
            });
        }

        document.getElementById('imageInput').addEventListener('change', async (e) => {
            if(!cvReady) return;
            
            const file = e.target.files[0];
            if(!file) return;

            const imgElement = document.createElement('img');
            imgElement.src = URL.createObjectURL(file);

            imgElement.onload = async () => {
                document.getElementById('status').innerText = "Ø¬Ø§Ø±ÙŠ ÙØ­Øµ 52 ÙˆØ±Ù‚Ø©... ğŸ”";
                
                let src = cv.imread(imgElement);
                
                // Ø§Ù„Ø¯ÙˆØ±Ø§Ù† Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ ÙˆÙØ­ØµÙ‡Ø§ ÙˆØ§Ø­Ø¯Ø© ØªÙ„Ùˆ Ø§Ù„Ø£Ø®Ø±Ù‰
                for (let card of cardsS) {
                    await checkCard(card, src);
                }

                document.getElementById('status').innerText = "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©! âœ…";
                src.delete();
            };
        });

        async function checkCard(cardName, src) {
            try {
                const templateUrl = `card_templates/${cardName}.png`;
                const response = await fetch(templateUrl);
                if (!response.ok) return; // Ø¥Ø°Ø§ Ø§Ù„ØµÙˆØ±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù…Ø¬Ù„Ø¯ ÙŠØªØ®Ø·Ø§Ù‡Ø§

                const blob = await response.blob();
                const templImg = await createImageBitmap(blob);
                
                let templ = cv.imread(templImg);
                let dst = new cv.Mat();
                let mask = new cv.Mat();
                
                // Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©
                cv.matchTemplate(src, templ, dst, cv.TM_CCOEFF_NORMED, mask);
                let result = cv.minMaxLoc(dst, mask);
                
                // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ·Ø§Ø¨Ù‚ Ø£ÙƒØ«Ø± Ù…Ù† 75% (ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§)
                if (result.maxVal > 0.75) {
                    document.getElementById(`card-${cardName}`).classList.add('hidden');
                }

                templ.delete(); dst.delete(); mask.delete();
            } catch (err) {
                console.log("Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„ÙˆØ±Ù‚Ø©: " + cardName);
            }
        }
    </script>
</body>
</html>
