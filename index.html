<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Ø¹Ø¯Ù‘ ÙˆØ±Ù‚ Ø§Ù„ØªØ±ÙŠÙƒØ³</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family: Arial;
  background:#eaeaea;
  text-align:center;
  padding:10px;
  margin:0;
}

h2{margin:20px 0 5px}
#count{font-size:20px;margin-bottom:10px}

/* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ÙˆØ±Ù‚ */
.cardsBox{
  background:#fff;
  padding:10px;
  border-radius:10px;
}

/* Ø²Ø± Ø§Ù„ÙˆØ±Ù‚Ø© */
.cardBtn{
  width:110px;
  height:80px;
  margin:6px;
  border:1px solid #ccc;
  border-radius:6px;
  background:#fff;
  font-size:32px;
  font-weight:bold;
}

/* Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø© (Ø£ÙØ¶Ù„ Ù…Ù† Ø§Ù„Ø¥Ø®ÙØ§Ø¡) */
.cardBtn.counted{
  opacity: 0.3; /* Ù„Ø¬Ø¹Ù„Ù‡Ø§ Ø¨Ø§Ù‡ØªØ© */
  pointer-events: none; /* Ù„Ù…Ù†Ø¹ Ø§Ù„Ø¶ØºØ· Ø¹Ù„ÙŠÙ‡Ø§ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ */
  text-decoration: line-through;
}

.S{color:#000;}
.H{color:#c62828;}
.D{color:#c62828;}
.C{color:#000;}

.stats{
  background:#fff;
  padding:10px;
  border-radius:10px;
  margin-top:10px;
}

/* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… */
.controlBtn{
  margin:5px;
  padding:10px 18px;
  font-size:15px;
  border:none;
  border-radius:6px;
  color:#fff;
}
.undo{background:#1976d2;}
.reset{background:#555;}
.add{background:#2e7d32;}
</style>
</head>

<body>

<h2>ğŸ‚¡ Ø¹Ø¯Ù‘ ÙˆØ±Ù‚ Ø§Ù„ØªØ±ÙŠÙƒØ³</h2>
<div id="count">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: 52</div>

<input type="file" id="screenshot" accept="image/*"><br><br>
<button class="controlBtn add" onclick="processScreenshot()">ğŸ“· ØªØ­Ù„ÙŠÙ„ Ù„Ù‚Ø·Ø© Ø§Ù„Ø´Ø§Ø´Ø©</button>

<div class="cardsBox" id="buttons"></div>
<div class="stats" id="stats"></div>

<button class="controlBtn undo" onclick="undo()">â†©ï¸ ØªØ±Ø§Ø¬Ø¹</button>
<button class="controlBtn reset" onclick="reset()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø©</button>

<script>
const suits = ['S','H','C','D']; // D = â™¦
const suitIcons = {S:'â™ ',H:'â™¥',D:'â™¦',C:'â™£'};
const ranks = ['A','K','Q','J','10','9','8','7','6','5','4','3','2'];

let cards = JSON.parse(localStorage.getItem("cards"));
let history = JSON.parse(localStorage.getItem("history")) || [];

if(!cards) reset();
else buildButtons();

function save(){
  localStorage.setItem("cards",JSON.stringify(cards));
  localStorage.setItem("history",JSON.stringify(history));
}

function reset(){
  // Ø·Ù„Ø¨ ØªØ£ÙƒÙŠØ¯ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¹Ø§Ø¯Ø©
  if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù„Ø¹Ø¨Ø©ØŸ Ø³ØªÙÙ‚Ø¯ ÙƒÙ„ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø©."))
    return;
    
  history=[];
  cards=[];
  for(let s of suits)
    for(let r of ranks)
      cards.push(r+s);

  save();
  buildButtons();
  update();
}

function play(card){
  if(!cards.includes(card)) return alert("Ø§Ù„ÙˆØ±Ù‚Ø© Ù…Ø­Ø³ÙˆØ¨Ø©!");
  history.push(card);
  cards = cards.filter(c => c!==card);
  save();
  // ØªØ¹Ø¯ÙŠÙ„: Ù†Ø·Ø¨Ù‚ ÙƒÙ„Ø§Ø³ "counted" Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† style.display="none"
  document.getElementById(card).classList.add("counted"); 
  update();
}

function undo(){
  if(history.length===0) return;
  let last = history.pop();
  cards.push(last);
  save();
  // ØªØ¹Ø¯ÙŠÙ„: Ù†Ø­Ø°Ù ÙƒÙ„Ø§Ø³ "counted" Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† style.display="inline-block"
  document.getElementById(last).classList.remove("counted");
  update();
}

function update(){
  const playedCount = 52 - cards.length;
  document.getElementById("count").innerText=`ØªÙ… Ø§Ù„Ù„Ø¹Ø¨: ${playedCount} | Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${cards.length}`;
  let text="";
  for(let s of suits){
    let c = cards.filter(x=>x.endsWith(s)).length;
    text += `${suitIcons[s]} Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${c}<br>`;
  }
  document.getElementById("stats").innerHTML=text;
}

function buildButtons(){
  let html="";
  for(let s of suits){
    for(let r of ranks){
      let c=r+s;
      // Ù†ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ØªÙ… Ø¹Ø¯Ù‡Ø§ Ù…Ø³Ø¨Ù‚Ø§Ù‹
      let isCounted = !cards.includes(c);
      let countedClass = isCounted ? " counted" : "";
      
      html+=`
      <button id="${c}" class="cardBtn ${s}${countedClass}"
      onclick="play('${c}')">
      ${r}${suitIcons[s]}
      </button>`;
    }
    html+="<br>";
  }
  document.getElementById("buttons").innerHTML=html;
}

// =================== Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ===================
async function recognizeCardsAI(base64Image) {
  const apiKey = "PUT_YOUR_API_KEY_HERE";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
  
  // ÙØ­Øµ Ø§Ù„Ù…ÙØªØ§Ø­
  if (apiKey === "PUT_YOUR_API_KEY_HERE" || apiKey.length < 10) {
      alert("ÙØ­Øµ Ø§Ù„Ù…ÙØªØ§Ø­: ÙØ´Ù„! ÙŠØ±Ø¬Ù‰ ÙˆØ¶Ø¹ Ù…ÙØªØ§Ø­ OpenAI Ø§Ù„Ø³Ø±ÙŠ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø£ÙˆÙ„Ø§Ù‹.");
      return [];
  }

  const response = await fetch("https://api.openai.com/v1/chat/completions", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + apiKey
    },
    body: JSON.stringify({
      model: "gpt-4-mini", 
      messages: [
        {
          role: "user",
          content: [
            { type: "text", text: "Ø§Ø³ØªØ®Ø±Ø¬ ÙƒÙ„ Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ø¸Ø§Ù‡Ø±Ø© ÙÙŠ Ø§Ù„ØµÙˆØ±Ø© ÙÙ‚Ø· Ø¨ØµÙŠØºØ© JSON Ù…Ø«Ù„: [\"Aâ™ \",\"10â™¦\"]. Ù„Ø§ ØªØ¶Ù Ø£ÙŠ Ù†Øµ ØªÙˆØ¶ÙŠØ­ÙŠ Ø¢Ø®Ø±." },
            { type: "image_url", image_url: { url: base64Image } }
          ]
        }
      ],
      max_tokens: 200
    })
  });
  
  // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡ API
  if (!response.ok) {
      const errorText = await response.text();
      console.error("Ø®Ø·Ø£ API:", errorText); 
      let errorMessage = "Ø§Ù„Ø®Ø·ÙˆØ© 3: ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø¯Ù…Ø© OpenAI.";
      
      if (response.status === 401) {
          errorMessage = "Ø§Ù„Ø®Ø·ÙˆØ© 3: ÙØ´Ù„! Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø³Ø±ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­ (401)!";
      } else {
          errorMessage += ` Ø§Ù„Ø­Ø§Ù„Ø©: ${response.status}.`;
      }
      alert(errorMessage);
      return [];
  }

  const data = await response.json();
  const rawContent = data.choices[0].message.content;
  console.log("Ø§Ø³ØªØ¬Ø§Ø¨Ø© OpenAI Ø§Ù„Ø®Ø§Ù… (Ù„Ù„ØªØµØ­ÙŠØ­):", rawContent);

  try {
    let cleanedContent = rawContent.trim();
    if (!cleanedContent.startsWith('[')) {
        cleanedContent = `[${cleanedContent}]`;
    }

    const detectedCardsArray = JSON.parse(cleanedContent);
    
    if (!Array.isArray(detectedCardsArray)) throw new Error("Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ù…ØµÙÙˆÙØ© JSON.");
    
    return detectedCardsArray;
  } catch (e) {
    alert("Ø§Ù„Ø®Ø·ÙˆØ© 4: ÙØ´Ù„! Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø£ÙŠ ÙˆØ±Ù‚ ÙˆØ§Ø¶Ø­ Ø£Ùˆ ØªÙ†Ø³ÙŠÙ‚ JSON ØºÙŠØ± ØµØ­ÙŠØ­.");
    console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ (JSON Error):", e);
    return [];
  }
}

// =================== Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ù…Ø¹ Ù†Ù‚Ø§Ø· ÙØ­Øµ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ (Checkpoints) ===================
async function processScreenshot(){
  const fileInput = document.getElementById("screenshot");
  
  // Ù†Ù‚Ø·Ø© ÙØ­Øµ 1: Ù‡Ù„ ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„ÙØŸ
  if(fileInput.files.length === 0) return alert("Ø§Ù„Ø®Ø·ÙˆØ© 1: ÙØ´Ù„! Ø§Ø®ØªØ± Ù„Ù‚Ø·Ø© Ø§Ù„Ø´Ø§Ø´Ø© Ø£ÙˆÙ„Ø§Ù‹.");
  
  alert("Ø§Ù„Ø®Ø·ÙˆØ© 1: Ù†Ø¬Ø­ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù.");

  const file = fileInput.files[0];
  const reader = new FileReader();

  reader.onload = async function(e){
    
    alert("Ø§Ù„Ø®Ø·ÙˆØ© 2: Ù†Ø¬Ø­Øª Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù (Reader Load). Ø³ÙŠØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ.");

    const base64Image = e.target.result;

    const detectedCards = await recognizeCardsAI(base64Image);
    
    // Ù†Ù‚Ø·Ø© ÙØ­Øµ 5: Ù‡Ù„ ØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ù†ØªÙŠØ¬Ø© Ù…Ù† Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠØŸ
    if (detectedCards.length === 0) return alert("Ø§Ù„Ø®Ø·ÙˆØ© 5: ÙØ´Ù„! Ù„Ù… ÙŠØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ Ø£ÙŠ ÙˆØ±Ù‚Ø©.");
    
    // ----------------------------------------------------
    // Ù†Ø¬Ø§Ø­: Ø¨Ø¯Ø£ Ø§Ù„ÙƒÙˆØ¯ Ø¨ØªÙ†ÙÙŠØ° Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚
    // ----------------------------------------------------
    let successfulPlays = 0; 

    detectedCards.forEach(card=>{
      // ØªØ­ÙˆÙŠÙ„ Ø´Ø§Ù…Ù„ Ù„Ù„Ø±Ù…ÙˆØ² ÙˆØ§Ù„Ù‚ÙŠÙ…Ø© 10 (Ù„Ø­Ø¸ Ø§Ù„ØªÙˆØ§ÙÙ‚)
      let code = card.trim()
                     .replaceAll("10","T") 
                     .replaceAll("â™ ","S") 
                     .replaceAll("â™¥","H") 
                     .replaceAll("â™¦","D") 
                     .replaceAll("â™¢","D") 
                     .replaceAll("â™£","C") 
                     .replaceAll("T","10");
      
      if(cards.includes(code)) {
          play(code);
          successfulPlays++;
      } else {
          console.log(`âŒ ÙØ´Ù„ Ø§Ù„Ø§Ø­ØªØ³Ø§Ø¨: Ø§Ù„ÙˆØ±Ù‚Ø© ${card} Ù„ÙŠØ³Øª ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ø­ÙˆÙ„ (${code}) ØºÙŠØ± ØµØ­ÙŠØ­.`);
      }
    });
    
    // Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
    if (successfulPlays > 0) {
        alert(`Ø§Ù„Ø®Ø·ÙˆØ© 5: Ù†Ø¬Ø§Ø­! ØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ ${successfulPlays} ÙˆØ±Ù‚Ø©.`);
    } else {
        alert(`Ø§Ù„Ø®Ø·ÙˆØ© 5: ÙØ´Ù„! ØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø£ÙˆØ±Ø§Ù‚ØŒ Ù„ÙƒÙ† Ù„Ù… ÙŠØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ Ø£ÙŠ Ù…Ù†Ù‡Ø§ (Ø±Ø¨Ù…Ø§ ÙƒØ§Ù†Øª Ù…Ø­Ø³ÙˆØ¨Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹).`);
    }

  };

  reader.onerror = function(e) {
      alert("Ø®Ø·Ø£ Ø­Ø§Ø³Ù…: ÙØ´Ù„ Ù…ØªØµÙØ­Ùƒ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù. (Reader Error)");
      console.error("ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù:", e);
  };

  reader.readAsDataURL(file);
  alert("Ø§Ù„Ø®Ø·ÙˆØ© 0: ØªÙ… Ø¨Ø¯Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù."); 
}
// ==============================================================================

</script>

</body>
</html>
