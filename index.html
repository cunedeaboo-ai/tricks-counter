<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø­Ù„Ù„ Ø§Ù„ØªØ±ÙŠÙƒØ³ Ø§Ù„Ø°ÙƒÙŠ</title>
    <script async src="https://docs.opencv.org/4.5.0/opencv.js" onload="onOpenCvReady();"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; background: #2c3e50; color: white; }
        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; padding: 15px; }
        .card { background: #ecf0f1; color: #333; border-radius: 5px; padding: 10px; font-weight: bold; transition: 0.3s; }
        .hidden { opacity: 0.1; transform: scale(0.8); pointer-events: none; }
        #status { margin: 20px; padding: 10px; border-radius: 5px; background: #34495e; }
        input { margin: 20px; padding: 10px; border-radius: 5px; border: none; }
    </style>
</head>
<body>

    <h2>ğŸƒ Ø¹Ø¯Ù‘Ø§Ø¯ ÙˆØ±Ù‚ Ø§Ù„ØªØ±ÙŠÙƒØ³ Ø§Ù„Ø°ÙƒÙŠ</h2>
    <div id="status">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ø­Ø±Ùƒ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ... â³</div>
    
    <input type="file" id="imageInput" accept="image/*" disabled>
    
    <div class="grid" id="board">
        </div>

    <canvas id="canvasOutput" style="display:none;"></canvas>

    <script>
        let cvReady = false;
        const cardsList = ['AS', 'KS', 'QS', 'JS', '10S', '9S', '8S', '7S', '6S', '5S', '4S', '3S', '2S'];

        function onOpenCvReady() {
            cvReady = true;
            document.getElementById('status').innerText = "Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø²! Ø§Ø±ÙØ¹ Ù„Ù‚Ø·Ø© Ø§Ù„Ø´Ø§Ø´Ø© ğŸš€";
            document.getElementById('imageInput').disabled = false;
            initBoard();
        }

        function initBoard() {
            const board = document.getElementById('board');
            cardsList.forEach(card => {
                const div = document.createElement('div');
                div.className = 'card';
                div.id = `card-${card}`;
                div.innerText = card;
                board.appendChild(div);
            });
        }

        document.getElementById('imageInput').addEventListener('change', async (e) => {
            if(!cvReady) return;
            
            const file = e.target.files[0];
            const imgElement = document.createElement('img');
            imgElement.src = URL.createObjectURL(file);

            imgElement.onload = async () => {
                document.getElementById('status').innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ ÙÙŠ Ø§Ù„ØµÙˆØ±Ø©... ğŸ”";
                
                let src = cv.imread(imgElement);
                
                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¢Øµ Ø§Ù„Ø³Ø¨ÙŠØª ÙƒÙ…Ø«Ø§Ù„
                await checkCard('AS', src);

                document.getElementById('status').innerText = "ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­! âœ…";
                src.delete();
            };
        });

        async function checkCard(cardName, src) {
            try {
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ ØµÙˆØ±Ø© Ø§Ù„Ù‚Ø§Ù„Ø¨ Ù…Ù† Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø°ÙŠ Ø£Ù†Ø´Ø£ØªÙ‡
                const templateUrl = `card_templates/${cardName}.png`;
                const response = await fetch(templateUrl);
                const blob = await response.blob();
                const templImg = await createImageBitmap(blob);
                
                let templ = cv.imread(templImg);
                let dst = new cv.Mat();
                let mask = new cv.Mat();
                
                cv.matchTemplate(src, templ, dst, cv.TM_CCOEFF_NORMED, mask);
                let result = cv.minMaxLoc(dst, mask);
                
                // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ·Ø§Ø¨Ù‚ Ø£ÙƒØ«Ø± Ù…Ù† 80%
                if (result.maxVal > 0.8) {
                    document.getElementById(`card-${cardName}`).classList.add('hidden');
                }

                templ.delete(); dst.delete(); mask.delete();
            } catch (err) {
                console.log("Ø§Ù„ÙˆØ±Ù‚Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø£Ùˆ Ø§Ù„ØµÙˆØ±Ø©: " + cardName);
            }
        }
    </script>
</body>
</html>
