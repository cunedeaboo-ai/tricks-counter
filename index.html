<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Ø¹Ø¯Ù‘ ÙˆØ±Ù‚ Ø§Ù„ØªØ±ÙŠÙƒØ³ Ø§Ù„Ø°ÙƒÙŠ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body{ font-family: Arial; background:#eaeaea; text-align:center; padding:10px; margin:0; }
  h2{margin:20px 0 5px}
  #count{font-size:20px;margin-bottom:10px}
  .cardsBox{ background:#fff; padding:10px; border-radius:10px; }
  .cardBtn{ width:110px; height:80px; margin:6px; border:1px solid #ccc; border-radius:6px; background:#fff; font-size:32px; font-weight:bold; cursor: pointer; }
  .cardBtn.counted{ opacity: 0.3; pointer-events: none; text-decoration: line-through; }
  .S{color:#000;} .H{color:#c62828;} .D{color:#c62828;} .C{color:#000;}
  .stats{ background:#fff; padding:10px; border-radius:10px; margin-top:10px; }
  .controlBtn{ margin:5px; padding:10px 18px; font-size:15px; border:none; border-radius:6px; color:#fff; cursor: pointer; }
  .undo{background:#1976d2;} .reset{background:#555;} .add{background:#2e7d32;} .add:disabled{background:#ccc;}
</style>
</head>
<body>

<h2>ğŸ‚¡ Ø¹Ø¯Ù‘ ÙˆØ±Ù‚ Ø§Ù„ØªØ±ÙŠÙƒØ³ Ø§Ù„Ø°ÙƒÙŠ</h2>
<div id="count">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: 52</div>

<div style="background: #fff; padding: 15px; border-radius: 10px; margin-bottom: 10px;">
  <label for="screenshot">ğŸ“¸ Ø§Ø±ÙØ¹ Ù„Ù‚Ø·Ø© Ø´Ø§Ø´Ø© Ù„Ù„Ø¹Ø¨Ø©:</label><br><br>
  <input type="file" id="screenshot" accept="image/*"><br><br>
  <button id="aiBtn" class="controlBtn add" onclick="processScreenshot()">ØªØ­Ù„ÙŠÙ„ ÙˆØ­Ø°Ù ØªÙ„Ù‚Ø§Ø¦ÙŠ</button>
</div>

<div class="cardsBox" id="buttons"></div>
<div class="stats" id="stats"></div>

<button class="controlBtn undo" onclick="undo()">â†©ï¸ ØªØ±Ø§Ø¬Ø¹</button>
<button class="controlBtn reset" onclick="reset()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø©</button>

<script>
const suits = ['S','H','C','D']; 
const suitIcons = {S:'â™ ',H:'â™¥',D:'â™¦',C:'â™£'};
const ranks = ['A','K','Q','J','10','9','8','7','6','5','4','3','2'];

let cards = JSON.parse(localStorage.getItem("cards"));
let history = JSON.parse(localStorage.getItem("history")) || [];

if(!cards) reset(); else buildButtons();

function save(){
  localStorage.setItem("cards",JSON.stringify(cards));
  localStorage.setItem("history",JSON.stringify(history));
}

function reset(){
  if(cards && cards.length < 52 && !confirm("Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù„Ø¹Ø¨Ø©ØŸ")) return;
  history=[]; cards=[];
  for(let s of suits) for(let r of ranks) cards.push(r+s);
  save(); buildButtons(); update();
}

function play(card){
  if(!cards.includes(card)) return;
  history.push(card);
  cards = cards.filter(c => c!==card);
  save();
  const el = document.getElementById(card);
  if(el) el.classList.add("counted"); 
  update();
}

function undo(){
  if(history.length===0) return;
  let last = history.pop();
  cards.push(last);
  save();
  const el = document.getElementById(last);
  if(el) el.classList.remove("counted");
  update();
}

function update(){
  const playedCount = 52 - cards.length;
  document.getElementById("count").innerText=`ØªÙ… Ø§Ù„Ù„Ø¹Ø¨: ${playedCount} | Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${cards.length}`;
  let text="";
  for(let s of suits){
    let c = cards.filter(x=>x.endsWith(s)).length;
    text += `${suitIcons[s]} Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${c}<br>`;
  }
  document.getElementById("stats").innerHTML=text;
}

function buildButtons(){
  let html="";
  for(let s of suits){
    for(let r of ranks){
      let c=r+s;
      let isCounted = !cards.includes(c);
      let countedClass = isCounted ? " counted" : "";
      html+=`<button id="${c}" class="cardBtn ${s}${countedClass}" onclick="play('${c}')">${r}${suitIcons[s]}</button>`;
    }
    html+="<br>";
  }
  document.getElementById("buttons").innerHTML=html;
}

// =================== Ø§Ù„Ø±Ø¨Ø· Ù…Ø¹ Ø³ÙŠØ±ÙØ± Render Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ ===================
async function processScreenshot(){
  const fileInput = document.getElementById("screenshot");
  const aiBtn = document.getElementById("aiBtn");
  if(fileInput.files.length === 0) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹!");

  const file = fileInput.files[0];
  const apiUrl = "https://tricks-counter.onrender.com/detect"; 

  aiBtn.innerText = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...";
  aiBtn.disabled = true;

  const formData = new FormData();
  formData.append('image', file);

  try {
    const response = await fetch(apiUrl, { method: "POST", body: formData });
    if (!response.ok) throw new Error();

    const data = await response.json();
    const detectedCards = data.cards; 

    if (!detectedCards || detectedCards.length === 0) {
      alert("Ù„Ù… ÙŠØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø£ÙˆØ±Ø§Ù‚ Ø¬Ø¯ÙŠØ¯Ø©.");
    } else {
      let count = 0;
      detectedCards.forEach(cardCode => {
        if(cards.includes(cardCode)) { play(cardCode); count++; }
      });
      if(count > 0) alert(`ØªÙ… Ø§ÙƒØªØ´Ø§Ù ÙˆØ­Ø°Ù ${count} ÙˆØ±Ù‚Ø©!`);
      else alert("Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ù…ÙˆØ¬ÙˆØ¯Ø© ÙˆÙ„ÙƒÙ†Ù‡Ø§ Ù…Ø­Ø³ÙˆØ¨Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹.");
    }
  } catch (error) {
    alert("ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØ³ØªÙŠÙ‚Ø¸ Ø§Ù„Ø¢Ù†ØŒ Ø§Ù†ØªØ¸Ø± 30 Ø«Ø§Ù†ÙŠØ© ÙˆØ­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹.");
  } finally {
    aiBtn.innerText = "ØªØ­Ù„ÙŠÙ„ ÙˆØ­Ø°Ù ØªÙ„Ù‚Ø§Ø¦ÙŠ";
    aiBtn.disabled = false;
  }
}
</script>
</body>
</html>
